#!/usr/bin/env bash

set -e

echo "[ bin/run ] Rebuilding Procfile.dev"
echo "# This is generated by bin/run. Do not edit" > Procfile.dev
echo "# Use this via bin/run" >> Procfile.dev
# We must bind to 0.0.0.0 inside a
# Docker container or the port won't forward
# Default binding is 127.0.0.1 for native
if [[ "$1" == "no-debug" ]]; then echo "web: bin/rails server  --binding=127.0.0.1" >> Procfile.dev
  echo "sidekiq: bin/sidekiq" >> Procfile.dev
else
  # start with "bin/run" to allow for debugging within VSCode
  echo "web: bundle exec rdbg --open --nonstop -c -- bin/rails server --binding=127.0.0.1" >> Procfile.dev
  echo "sidekiq: bundle exec rdbg --open --nonstop -c -- bin/sidekiq" >> Procfile.dev
fi

set +e
# Will check if redis responds with not an error exit
# if it does not, it will start Redis
if redis-cli ping &>/dev/null; then
  echo "[ bin/run ] Redis is already running"
else
  echo "[ bin/run ] Starting Redis"
  brew services start redis
fi
set -e

echo "[ bin/run ] Starting foreman"
bin/foreman start -f Procfile.dev -p 3000